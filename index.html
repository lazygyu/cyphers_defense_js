<!doctype html5>
<html>
<head>
	<title>HTML5 demo</title>
	<script type="text/javascript" src="http://code.createjs.com/easeljs-0.5.0.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script type="text/javascript" src="js/TileMap.js"></script>
	<script type="text/javascript" src="js/ContentManager.js"></script>
	<script type="text/javascript" src="js/player.js"></script>
	<script type="text/javascript">
		var stage, map, contentManager, player, layer1, fpstxt;
		var Direction = ['s', 'sw', 'w', 'nw', 'n', 'ne', 'e', 'se'];
		function init(){
			stage = new createjs.Stage("mainCanvas");
			map = new TileMap({stage : stage, width:50, height:37, z:0});
			layer1 = new TileMap({stage:stage, width:50, height:37, z:1});
			map.setMapChip('images/town01_a.png');
			layer1.setMapChip('images/town01_a.png');

			fpstxt = new createjs.Text('--- fps', "bold 14px Arial", 'white');
			fpstxt.z = 9;
			
			contentManager = new ContentManager();
			contentManager.SetDownloadComplated(startGame);
			contentManager.StartDownload();
		}
		
		var keys = {};

		function keydownproc(e){
			if(!e) e=event;
			if(!keys[e.keyCode]){
				keys[e.keyCode] = 1;
				keyproc(e);
			}
		}

		function keyproc(e){
			console.log("key down : " + e.which);
			player.selected = true;
			
			if( !e ) e = event;
			var c = player.spriteSheet.getFrame(player.currentFrame);
			console.log(c.regY + "/" + player.y);
			switch(e.which){
				case 32:
					player.gotoAndPlay("attack_" + player.direction);
					player.state = 2;
					break;
				case 13:
					player.setDirection(Direction[(Direction.indexOf(player.direction) + 1)%8]);
					break;
				case 38:
					player.setDirection('n');
					player.gotoAndPlay('walk_n');
					player.state = 1;
					break;
				case 40:
					player.setDirection('s');
					player.gotoAndPlay('walk_s');
					player.state = 1;
					break;
				case 39:
					player.setDirection('e');
					player.gotoAndPlay('walk_e');
					player.state = 1;
					break;
				case 37:
					player.setDirection('w');
					player.gotoAndPlay('walk_w');
					player.state = 1;
					break;
			}
		}

		function keyupproc(e){
			if( !e ) e = event;
			keys[e.keyCode] = 0;
			player.state = 0;
			player.selected = false;
			player.gotoAndPlay('stand_' + player.direction);
		}

		function startGame(){
			//map.createRandom();
			$.ajax({url:'datas/stage1.map', success:function(txt){
				map.parseText(txt);
				stage.addChild(map);
				player = new Character(contentManager.imgDimus);
				player.z = 1;
				
				player.x = 300;
				player.y = 300;
				createjs.Ticker.addListener(window);
				//createjs.Ticker.useRAF = true;
				createjs.Ticker.setFPS(60);
				stage.update();
				stage.addChild(fpstxt);
				document.onkeydown = keydownproc;
				document.onkeyup = keyupproc;
			}});

			$.ajax({url:'datas/stage1_layer1.map', success:function(txt){
				layer1.parseText(txt);
				stage.addChild(player);
				stage.addChild(layer1);
			}});
		}

		function sortfunc(a, b){
			if(a.z == b.z){
				return a.y - b.y;
			}else{
				return a.z - b.z;
			}
		}

		var fps = 0;
		var lasty = 0;

		function tick(){
			var ch = false;
			/*
			if( lasty != player.y ){
				for(var i=0;i<1850;i++){
					if( layer1.tiles[i].no == null ) continue;
					if( player.hitRect( layer1.tiles[i].getRect() ) ){
						ch = true;
						break;
					}
				}
			}
			*/
			lasty = player.y;
			if( ch ) stage.sortChildren(sortfunc);
			fpstxt.text = Math.round(createjs.Ticker.getMeasuredFPS()) + " fps";
			//fpstxt.update();
			player.tick();
			stage.update();
			
		}
	</script>
</head>
<body onload="init();">
	<canvas id="mainCanvas" width="800" height="600">
		This page needs a browser that support the canvas.
	</canvas>
</body>
</html>
